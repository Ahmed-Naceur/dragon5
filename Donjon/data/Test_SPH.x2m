*----
*  Name          : TEST Test_SPH.x2m
*  Author        : Alain Hebert (2018)
*
*  17 X 17 PWR ASSEMBLY WITH NEWTONIAN SPH EQUIVALENCE
*----
*  Define STRUCTURES and MODULES used
*----
LINKED_LIST
  SPHGEOM MTRACK MACRO MACRO2 SYS OPTIM OUT CALC ;
MODULE
  TRIVAT: TRIVAA: FLUD: DELETE: UTL: GREP: END: ;
DOUBLE Fobj ;
SEQ_ASCII _OUT :: FILE './_OUT' ;
PROCEDURE SPH_Optim ;
PROCEDURE assertS ;
INTEGER IterEmax := 1000 ;

*----
* TRANSPORT-DIFFUSION NEWTONIAN SPH EQUIVALENCE
*----
OUT := _OUT ;
SPHGEOM := OUT :: STEP UP 'MACRO-GEOM' ;
MTRACK := TRIVAT: SPHGEOM :: DUAL (*IELEM=*) 1 (*ICOL=*) 1 ;
MACRO := OUT :: STEP UP 'REF-CASE0001' STEP UP 'MACROLIB' ;

MACRO2 OPTIM := SPH_Optim MACRO SPHGEOM MTRACK
   :: 0.5 1.5 1.0E-3 <<IterEmax>> ;
ECHO "control variables at convergence" ;
UTL: OPTIM :: IMPR 'VAR-VALUE' * ;

GREP: OPTIM :: GETVAL 'FOBJ-CST-VAL' 1 >>Fobj<< ;
ECHO "optimal objective function=" Fobj ;

*----
* VERIFICATION CALCULATION
*----
SYS := TRIVAA: MACRO2 MTRACK ;
CALC := FLUD: SYS MTRACK :: EDIT 2 ADI 4 ACCE 5 3 ;
assertS CALC :: K-EFFECTIVE 1 0.9554875 ;

ECHO "test Test_SPH completed" ;
END: ; 
QUIT "LIST" .
